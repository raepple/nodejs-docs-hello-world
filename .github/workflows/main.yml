on: [push]
name: Linux_Container_Workflow

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
        # checkout the repo
        - name: Checkout GitHub Action
          uses: actions/checkout@master
          
        - name: 'Login via Azure CLI'
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
        
        - uses: azure/docker-login@v1
          with:
            login-server: acr4devops.azurecr.io
            username: ${{ secrets.REGISTRY_USERNAME }}
            password: ${{ secrets.REGISTRY_PASSWORD }}
        - run: |
            docker build -t acr4devops.azurecr.io/devopsdemoapp:${{ github.sha }} .
            docker push acr4devops.azurecr.io/devopsdemoapp:${{ github.sha }}
            
        - name: Azure Kubernetes set context
          uses: azure/aks-set-context@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
            resource-group: devopsaks
            cluster-name: aks4devops
        
        - name: Create imagepullsecret for Azure Container registry (ACR)
          uses: azure/k8s-create-secret@v1.1
          with:
            namespace: default
            container-registry-url: acr4devops.azurecr.io
            container-registry-username: ${{ secrets.REGISTRY_USERNAME }}            
            container-registry-password: ${{ secrets.REGISTRY_PASSWORD }}
            secret-name: devopsdemo-cr

        - name: Baking the helm chart to generate the manifests to deploy
          uses: Azure/k8s-bake@v1
          with:
            # Acceptable values: helm or kompose or kustomize
            renderEngine: helm            
            helmChart: ./devopschart/
            helm-version: latest
            overrides: |
              image.tag:${{ github.sha }}
          id: bake
            
        - name: Deploy app to AKS
          uses: azure/k8s-deploy@v1.3
          with:
            manifests: ${{ steps.bake.outputs.manifestsBundle }}
            images: |
              acr4devops.azurecr.io/devopsdemoapp:${{ github.sha }}
            imagepullsecrets: |
              devopsdemo-cr
            strategy: blue-green
            route-method: ingress
            version-switch-buffer: 15
            namespace: default

        - name: Deploy to Azure Container Instances (ACI)
          uses: azure/aci-deploy@v1
          with:
            resource-group: devopsaks
            dns-name-label: devopsdemoapp
            image: acr4devops.azurecr.io/devopsdemoapp:${{ github.sha }}
            registry-login-server: acr4devops.azurecr.io
            registry-username: ${{ secrets.REGISTRY_USERNAME }}
            registry-password: ${{ secrets.REGISTRY_PASSWORD }}
            name: devopsdemoapp-container
            location: northeurope
